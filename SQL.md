[TOC]



# 0. 版权声明

- SQL 系列读书笔记来源于 Ben Forta 所著《SQL 必知必会》[1]；
- 该系列笔记不以盈利为目的，仅用于个人学习、课后复习及科学研究；
- 如有侵权，请与本人联系（hqpan0@gmail.com），经核实后即刻删除；



# 1. SQL 基础

## 1.1 术语

|    英文     | 中文 |                          释义                           |
| :---------: | :--: | :-----------------------------------------------------: |
|   column    |  列  |         表中的一个字段，每列都有相应的数据类型          |
| primary key | 主键 |                            -                            |
|     row     |  行  |          表中的一个记录（record，非正式用语）           |
|   schema    | 模式 |                            -                            |
|    table    |  表  | 类似于EXCEL中的一张表，存储某种特定类型数据的结构化清单 |



## 1.2 概念释义

- DBMS 与 SQL 的区别：
  - DBMS：数据库管理系统，指数据库软件；
  - SQL：Structured Query Language，结构化查询语言；
- 模式：
  - 可用于描述表的特性，包括表中包含何种数据、数据如何分解、如何存储、各部分信息如何命名；
  - 也用于描述各个表之间的关系；
- 定义主键的要求：
  - 每行的主键值不能为`NULL`；
  - 主键值不得修改、重用；
  - 若将多列作为主键，则各列的组合值必须唯一（单个列的值允许相同）；



# 2. 检索数据

## 2.1 术语

|  英文   |  中文  | 释义 |
| :-----: | :----: | :--: |
| keyword | 关键字 |  -   |
|         |        |      |
|         |        |      |



## 2.2 检索

- 多条SQL语句以`；`分隔；

- SQL语句不区分大小写；

  - 将SQL关键字大写，列名和表名使用小写，提高代码可读性；

- 处理SQL语句时，忽略其中所有空格；
  - SQL语句可写在一行之中，也可写为多行；
  - 将SQL语句分成多行，易于阅读和调试；

- SQL一般返回原始的、无格式的数据；

- 按列检索：
  - 检索多列：用逗号分隔列名；
  ```mysql
  SELECT Prod_id, prod_name, prod_price 
  FROM Products;
  ```

  - 检索所有列：使用通配符；
    - 使用通配符可检测出列名未知的列；

  ```mysql
  SELECT *
  FROM Products;
  ```

- 检索不同的值：

  - 仅返回某一列中的值，每个不同的值仅显示一次；

  ```mysql
  SELECT DISTINCT vend_id
  FROM Products;
  ```

  - `DISTINCT`应置于列名之前，同时作用于多个列，会返回两列中的所有值，每个不同的值仅显示一次；

- 返回前若干行：不同的DBMS有不同的语法，以下语法仅针对MySQL；

  ```mysql
  SELECT prod_name
  FROM Products
  LIMIT 5;
  ```

  - 仅显示符合要求的前5行；

  ```mysql
  LIMIT 5 OFFSET 5;	-- MySQL支持简化版的 LIMIT 语句；
  LIMIT 3,4;			-- 第一个数字表示起始行，第二个数字表示需要返回的行数；
  ```

  - `OFFSET`后的数字表示起始行的编号，但检索时不包括该行，而是返回从下一行开始的检索结果；
    - 换言之，将该关键字后的行视为第0行，检索时仅返回从第1行开始的检索结果；

- 注释：

  ```mysql
  -- 两个连字符，实现行内注释；（多种 DBMS 支持该种形式的注释）
  #  一个井号，实现行内注释；（一小部分 DBMS 支持该种形式的注释）
  /* ... 多行注释 ... */ 
  ```

# 3. 排序检索数据

## 3.1 术语

|  英文  | 中文 | 释义 |
| :----: | :--: | :--: |
| clause | 子句 |  -   |
|        |      |      |
|        |      |      |

- 数据排序的具体规则取决于数据库管理员的设置方式；
  - A与a是否相同？
  - a位于B之前亦或是Z之后？
  - ……



## 3.2 排序数据

- 子句：SQL 语句由子句构成；

- `ORDER BY`子句应作为`SELECT`语句中的最后一个子句，否则报错；

  - 按单列排序：

    ```mysql
  ORDER BY prod_name;    -- 根据列名指定作为排序依据的列；
    ORDER BY 2;            -- 根据相对位置指定作为排序依据的列；
    ```
  - 按多个列排序：
  
  ```mysql
    ORDER BY prod_price, prod_name;
    ORDER BY 2,3;          -- 根据相对位置指定作为排序依据的列；
  ```
  
- 根据相对位置指定作为排序依据的列：

  - 优点：无需指定列名；
  - 缺点：不明确指定列名，容易引发排序错误；
  - 指定列名、使用相对列位置，两种方法可混用；



## 3.3 指定排序方向

- 升降序排列的关键字：

  - 降序：`DESC` 或 `DESCENDING`；

  - 升序：`ASC` 或 `ASCENDING`；
    - 由于`ORDER`默认按升序排列，因此该关键字无太大用处；

- 指定排序方向：

  - 升序排列：`ORDER`子句默认按升序排序；

  - 降序排列：在指定列后使用关键词`DESC`；

    ```mysql
    ORDER BY prod_price DESC;
    ```

  - 对多列进行降序排列：

    ```mysql
    ORDER BY prod_price DESC, prod_name;
    ```

    - `DESC`关键字仅作用于该关键字前的一列；
    - 如需制定多列按降序排列，应为每列加上`DESC`；




# 4. 过滤数据

## 4.1 术语

|               英文               |       中文        | 释义 |
| :------------------------------: | :---------------: | :--: |
| search criteria/filter condition | 搜索条件/过滤条件 |  -   |
|                                  |                   |      |
|                                  |                   |      |



## 4.2  WHERE 子句及操作符

- NULL不同于空字符串`""`、0、空格；
  
- `WHERE`子句的位置：
  
  - 应置于表名（`FROM`子句）之后；
  
  - 应置于`ORDER`子句之前；
  - `WHERE`子句后接条件操作符；
  
- 不同DBMS支持不同种类的操作符：

  - 具体差异参见相应 DBMS 文档；

  - 操作符存在冗余现象；
  
  | 操作符  |             含义             |
  | :-----: | :--------------------------: |
  |   <>    |      不等于（等同于!=）      |
  |   !>    | 不大于（等同于“小于等于”<=） |
  |   !<    | 不小于（等同于“大于等于”>=） |
  | BETWEEN |      在指定的两个值之间      |
  | IS NULL |           为NULL值           |



## 4.3 使用操作符

- 若`WHERE`子句中涉及到字符串，则应使用单引号，用于限定字符串；

- `BETWEEN`操作符的使用方法：

    ```mysql
    WHERE prod_price BETWEEN 5 AND 10;
    ```

- 空值检查：
    - 注意：不能简单的检查某项是否等于NULL；
      - 原因：NULL不是一个数，各个NULL被认为不相同；
    ```mysql
    WHERE cust_email IS NULL;
    ```

# 5. 高级数据过滤

## 5.1 术语

|           英文            |       中文        | 释义 |
| :-----------------------: | :---------------: | :--: |
| operator/logical operator | 操作符/逻辑操作符 |  -   |
|                           |                   |      |

## 5.2 多个 WHERE 子句组合使用

- 常见的操作符：
  - `AND`、`OR`；
  - `IN`、`NOT`；

- `AND`操作符的用法：

  ```mysql
  WHERE vend_id = 'DLL01' AND prod_price <= 4;
  ```

- `OR`操作符：很多DBMS若判断`OR`操作符中第一个条件被满足，则不再判断第二个条件；

  - 可用n-1个操作符连接n个条件；
  - `AND`操作符的优先级高于`OR`操作符；
    - 注意：不过分依赖操作符的优先级，在`WHERE`子句中使用圆括号消除歧义；  

- `IN`操作符：指定匹配值清单，功能与`OR`相当；

  ```mysql
  WHERE vend_id IN ('DLL01', 'BRS01');
  ```

  - 使用`IN`操作符的理由：
    - `IN`操作符的语法更直观；
    - 当与其他操作符组合使用时，求值顺序易于管理；
    - 执行速度相较于`OR`操作符更快；
    - （最重要的优点）可以包含其他`SELECT`语句，便于更动态地建立`SELECT`子句；

- `NOT`操作符：

  ```mysql
  WHERE NOT vend_id = 'DLL01';
  ```

  - 大多数DBMS允许`NOT`操作符否定任何条件；



# 6. 用通配符进行过滤

## 6.1 术语

|      英文      |   中文   | 释义 |
| :------------: | :------: | :--: |
|    wildcard    |  通配符  |  -   |
| search pattern | 搜索模式 |  -   |
|   predicate    |   谓词   |  -   |

- 通配符的种类：不同的 DBMS 支持不同类型的通配符；
  - `%`：匹配任意数量的任意字符；
  - `_`：匹配某一个字符；
  - `[]`：匹配候选字符集中的某一个字符；
    - 仅有 Access、SQL Server 支持`[]`；
- 搜索模式：由字面值、通配符或两者组合构成的搜索条件；
- 不同的 DBMS 及配置，可以决定是否在搜索时区分大小写；



## 6.2 通配符的使用方法

- 通配符的使用要求：
  - `LIKE`操作符指示 DBMS，后接的搜索模式借助于通配符匹配；
    - 作为谓词使用时，操作符不再被视为操作符；
    - 从技术上分析，`LIKE`是谓词，而非操作符；
  - 通配符搜索仅适用于文本字段（字符串），不适用于非文本数据类型；
  - 通配符可以出现在搜索模式的任意位置，并且允许多个通配符同时使用；

- `%`通配符：

  - 能表示0个字符；

  - 不能匹配 NULL；

  - 很多 DBMS 使用空格填补字段内容，应如何处理？

    - E.g. 规定某列应有50个字符，但实际存储的文本的仅有17个字符，则在文本后附加33个空格；

    - Solution：如下代码中的第二个通配符用于匹配 y 之后的字符；

      ```mysql
      WHERE prod_name LIKE 'f%y%'
      ```

    - Better Solution：使用函数去除空格；

- `[]`通配符：在 Access 中，可用前缀字符`^`（脱字号）或`NOT`对该集合取反；

  - `^`相较于`NOT`的优点：应用于多个 WHERE 子句的情况时，可简化语法；

  ```mysql
  WHERE cust_contact LIKE '^[JM]%';   
  ```




## 6.3 使用通配符的原则

- 通配符的缺点：应用通配符进行搜索时，时间开销大；

  - 不过度使用通配符：若使用其它操作符能完成的功能，应尽量不使用通配符；

  - 尽量避免将通配符置于搜索模式的开头，否则将增大时间开销；

    ```mysql
    WHERE prod_name LIKE '% inch teddy bear';
    ```




# 7 创建计算字段

## 7.1 术语

|      英文      |    中文     |      释义      |
| :------------: | :---------: | :------------: |
|     field      |    字段     |       -        |
|  concatenate   |    拼接     | 将值联结到一起 |
| derived column | 导出列/别名 |       -        |

- 字段：与“列”的意思基本相同，常互换使用；

  - 数据库中的列一般称为“列”；
  - “字段”通常与“计算”一起使用，“计算字段”；



## 7.2 使用细节

- 字段并不实际存在于数据库表中，而是运行时在`SELECT`语句内创建的；

  - 此时`SELECT`语句返回一个计算字段（列）；

- 区分：

  - 只有数据库知道`SELECT`语句中哪些列是实际的表列，哪些列是计算字段；
  - 从客户端（E.g. 应用程序）来看，计算字段的数据与其他列的数据返回方式相同；
  - 很多格式转换和格式化工作，既可以在数据库服务器上完成，又可以在客户端应用程序内完成，但在数据库服务器上执行这些操作更快；

- 部分 DBMS 将计算字段保存为填充为列宽的文本值，有些时候需要去除这些多余的空格：

  - RTRIM()：除去字符串右侧空格；
  - LTRIM()：除去字符串左侧空格；
  - TRIM()：除去字符串两侧空格；
    - trim, vt.&n.修剪；

- MySQL 中使用函数`CONCAT`拼接两列：

  ```mysql
  SELECT CONCAT(vend_name, ' (', vend_country, ')')
  ```



## 7.3 使用别名

- 别名：亦称导出列；

- 使用关键字`AS`：

  ```mysql
  SELECT quantiyt*item_price AS expended_price
  ```

  - SQL 支持的基本算术运算包括：`+`、`-`、`*`、`/`；

- 别名的用途：

  - 为计算字段命名，便于客户端引用；

  - 当现有的表列名包含不合法字符（E.g. 空格）或易混淆时，可予以修正；

- 别名的命名原则：

  - 别名可以是一个单词或一个字符串，若为字符串，则应将字符串括在引号中；
    - 将字符串括在引号中，容易给客户端应用带来麻烦；
    - 推荐使用一个单词命名；

- `SELECT`语句可用于测试、检验函数、计算表达式；

  ```mysql
  SELECT 2*3			-- 计算表达式 2*3；
  SELECT NOW()		-- 返回当前时间和日期；
  ```

  

# 8. 使用函数处理数据

## 8.1 术语

|   英文   |   中文   | 释义 |
| :------: | :------: | :--: |
| portable | 可移植的 |  -   |

​    

## 8.2 使用 SQL 函数需要注意的问题

- 几乎所有的 DBMS 都支持相同的 SQL 语句，但各个 DBMS 的函数大多各不相同；

  - SQL 语句可移植；
  - SQL 函数不可移植；
    - 使用 SQL 函数应做好注释，以便于日后他人了解代码的功能；

- 若干个常用的函数：

  ```mysql
  SUBSTRING();		-- 提取字符串的组成部分；
  CONVERT();			-- 数据类型转换；
  
  CURDATE();			-- 取当前日期；
  YEAR();				-- 从日期中提取年份；
  
  LENGTH();			-- 返回字符串的长度；
  SOUNDEX();			-- 返回字符串的SOUNDEX值；
  
  LEFT();				-- 返回字符串左边的字符；
  RIGHT(); 			-- 返回字符串右边的字符；
  
  LOWER();			-- 将字符串转换为小写；
  UPPER();			-- 将字符串转换为大写；
  ```

  - 关于 `SOUNDEX()` 函数：将文本串转换为其语音表示的字母数字模式；

  - 使用`SOUNDEX()` 函数检索虽拼写错误，但发音相近的文本串；

    ```mysql
    WHERE SOUNDEX(cust_contact) = SOUNDEX('Michael Green');
    ```

- 数值处理函数：

  ```mysql
  PI();				-- 返回圆周率；
  
  ABS();				-- 返回一个数的绝对值；
  SQRT();				-- 返回一个数的平方根；
  EXP();				-- 返回一个数的指数值；
  
  SIN();				-- 返回一个角度的正弦值；
  COS();				-- 返回一个角度的余弦值；
  TAN();				-- 返回一个角度的正切；
  ```




# 9. 汇总数据

## 9.1 术语

|        英文        |   中文   | 释义 |
| :----------------: | :------: | :--: |
| aggregate function | 聚集函数 |  -   |



## 9.2 5个聚集函数

- 各 DBMS 对聚集函数的支持基本一致；
- SQL 聚集函数：
  - `MAX()`；
  - `MIN()`；
  - `SUM()`；
  - `AVG()`；
  - `COUNT()`；

- `MAX()`：

  - 忽略值为 NULL 的行；
  - 可找出最大的数值或日期值；
  - 许多 DBMS 允许将该函数应用与文本数据，返回该列排序后的最后一行；

- `MIN()`：

  - 忽略值为 NULL 的行；
  - 许多 DBMS 允许将该函数应用与文本数据，返回该列排序后的最前面的一行；

- `SUM()`：

  - 忽略值为 NULL 的行；

- `AVG()`:

  - 忽略值为 NULL 的行；
  - 必须指定列名作为参数；

  - 只能用于单个列，若要获得多个列的均值，则需使用多个`AVG()`；

- `COUNT()`：

  ```mysql
  SELECT COUNT(*) AS num_cust		
  -- 以星号为参数，返回该列所有行的数量；
  SELECT COUNT(cust_email) AS num_cust  
  -- 以列名为参数，返回该列所有非空值的行的数量；
  ```

- `DISTINCT`参数对不同的值进行计算，`ALL`为默认参数，无需指定；

  - `DISTINCT`参数不必用于`MAX()`、`MIN()`中，无意义；

  - 由于该参数必须使用列名，因此不可用于`COUNT(*)`中；

  - 适用于如下情形：

    ```mysql
    SUM(DISTINCT column_name)   -- 返回该列中所有不同值之和
    AVG(DISTINCT column_name)   -- 返回该列中所有不同值的均值
    COUNT(DISTINCT column_name) -- 返回该列中所有不同值的行数
    ```

    



# ==Schedule==

- 每周一课，应于07月26日完成；
- 后续课程：数据库理论知识；
  - 购置配套教材一册；
    - 数据库系统概念(原书第6版.本科教学版)；
  - 配套实验教材或进阶SQL教材一册；
  - 每日一小时，补充数据库基础知识；



# References

[1] Ben Forta. SQL 必知必会[M]. 钟鸣, 刘晓霞 等译. 北京: 人民邮电出版社, 2013. ︎